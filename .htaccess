# =====================================================
# BRICKSTONE REALTY GROUP — .htaccess
# Apache config for WhoGoHost shared hosting
# =====================================================


# -----------------------------------------------
# PHP PRODUCTION HARDENING
# Prevent PHP errors from leaking into page output
# or JSON API responses. Errors are logged server-
# side via php_flag log_errors On.
# -----------------------------------------------
<IfModule mod_php.c>
  php_flag  display_errors         Off
  php_flag  display_startup_errors Off
  php_flag  log_errors             On
  php_value error_reporting        32767
</IfModule>
# php8 handler variant (common on cPanel hosts)
<IfModule mod_php8.c>
  php_flag  display_errors         Off
  php_flag  display_startup_errors Off
  php_flag  log_errors             On
  php_value error_reporting        32767
</IfModule>


# -----------------------------------------------
# HTTPS ENFORCEMENT
# Redirect all HTTP → HTTPS + www
# -----------------------------------------------
RewriteEngine On

# Redirect non-www to www
RewriteCond %{HTTP_HOST} ^brickstonerealtygroups\.com$ [NC]
RewriteRule ^(.*)$ https://www.brickstonerealtygroups.com/$1 [R=301,L]

# Redirect HTTP to HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]


# -----------------------------------------------
# PROTECT PHP BACKEND ENDPOINTS
# Block direct browser navigation and cross-origin
# access to the contact form PHP files.
# NOTE: RewriteRule must be in the global context
# (NOT inside <FilesMatch>) to work on shared hosts.
# -----------------------------------------------

# Block handle-contact.php unless Referer is from our domain (www, non-www, or localhost)
RewriteCond %{REQUEST_URI} ^/handle-contact\.php$ [NC]
RewriteCond %{HTTP_REFERER} !^https://(www\.)?brickstonerealtygroups\.com/ [NC]
RewriteCond %{HTTP_REFERER} !^http://localhost/ [NC]
RewriteRule .* - [F,L]

# csrf-token.php is called by JS on page load — no Referer is sent at that point.
# Origin validation is handled inside the PHP file itself, so no Apache block here.


# -----------------------------------------------
# SECURITY HEADERS
# -----------------------------------------------
<IfModule mod_headers.c>
  # Prevent clickjacking
  Header always set X-Frame-Options "DENY"

  # Prevent MIME sniffing
  Header always set X-Content-Type-Options "nosniff"

  # XSS Protection (legacy browsers)
  Header always set X-XSS-Protection "1; mode=block"

  # HSTS — force HTTPS for 1 year
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

  # Referrer policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # Permissions policy — disable unused browser APIs
  Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"

  # Content Security Policy
  # script-src: no unsafe-inline — all JS is in external files (js/main.js)
  # style-src:  unsafe-inline kept — Tailwind CDN injects inline styles at runtime
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' https://cdn.tailwindcss.com; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"

  # Remove server fingerprinting headers
  Header always unset Server
  Header always unset X-Powered-By
  Header always unset X-AspNet-Version
  Header always unset X-AspNetMvc-Version

  # Vary: Accept-Encoding — required for correct GZIP caching by CDNs/proxies
  Header append Vary Accept-Encoding
</IfModule>


# -----------------------------------------------
# ETAG — remove (leaks inode/size, breaks multi-server caching)
# -----------------------------------------------
FileETag None
<IfModule mod_headers.c>
  Header always unset ETag
</IfModule>


# -----------------------------------------------
# CORS — PHP API endpoints only
# Allows same-origin fetch() calls to succeed.
# Handles the OPTIONS preflight browsers send
# before cross-origin POST requests.
# -----------------------------------------------
<FilesMatch "^(handle-contact|csrf-token)\.php$">
  <IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin  "https://www.brickstonerealtygroups.com"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, X-Requested-With"
    Header always set Access-Control-Max-Age       "86400"
  </IfModule>
</FilesMatch>

# Respond 204 No Content to OPTIONS preflight without hitting PHP
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteCond %{REQUEST_URI} ^/(handle-contact|csrf-token)\.php$ [NC]
RewriteRule .* - [R=204,L]


# -----------------------------------------------
# CUSTOM ERROR PAGES
# -----------------------------------------------
ErrorDocument 404 /404.html
ErrorDocument 403 /404.html
ErrorDocument 500 /404.html


# -----------------------------------------------
# GZIP COMPRESSION
# -----------------------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/font-woff
  AddOutputFilterByType DEFLATE application/font-woff2
</IfModule>


# -----------------------------------------------
# BROWSER CACHING — per file type
# -----------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML — short (content changes)
  ExpiresByType text/html                  "access plus 1 hour"

  # CSS & JS — 1 month (fingerprint filenames when deploying)
  ExpiresByType text/css                   "access plus 1 month"
  ExpiresByType application/javascript     "access plus 1 month"
  ExpiresByType text/javascript            "access plus 1 month"

  # Images
  ExpiresByType image/png                  "access plus 6 months"
  ExpiresByType image/jpg                  "access plus 6 months"
  ExpiresByType image/jpeg                 "access plus 6 months"
  ExpiresByType image/gif                  "access plus 6 months"
  ExpiresByType image/svg+xml              "access plus 6 months"
  ExpiresByType image/webp                 "access plus 6 months"
  ExpiresByType image/x-icon               "access plus 1 year"

  # Fonts
  ExpiresByType font/woff                  "access plus 1 year"
  ExpiresByType font/woff2                 "access plus 1 year"
  ExpiresByType application/font-woff      "access plus 1 year"
  ExpiresByType application/font-woff2     "access plus 1 year"

  # PHP endpoints — NEVER cache
  ExpiresByType application/x-httpd-php    "access plus 0 seconds"
</IfModule>


# -----------------------------------------------
# CACHE-CONTROL HEADERS
# -----------------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "\.(css|js)$">
    Header set Cache-Control "public, max-age=2592000, immutable"
  </FilesMatch>
  <FilesMatch "\.(png|jpg|jpeg|gif|svg|webp|ico|woff|woff2)$">
    Header set Cache-Control "public, max-age=15552000, immutable"
  </FilesMatch>
  <FilesMatch "\.html$">
    Header set Cache-Control "public, max-age=3600, must-revalidate"
  </FilesMatch>
  # PHP responses must never be cached by browsers or proxies
  <FilesMatch "\.php$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
  </FilesMatch>
</IfModule>


# -----------------------------------------------
# BLOCK SENSITIVE FILES
# -----------------------------------------------
<FilesMatch "(^\.htaccess|\.htpasswd|\.git|\.env|\.log|\.sh|composer\.json|package\.json)$">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# Block directory browsing
Options -Indexes


# -----------------------------------------------
# MIME TYPES
# -----------------------------------------------
<IfModule mod_mime.c>
  AddType image/svg+xml         .svg .svgz
  AddType image/webp            .webp
  AddType font/woff             .woff
  AddType font/woff2            .woff2
  AddType application/javascript .js
</IfModule>


# -----------------------------------------------
# SITEMAP
# robots.txt at root handles Sitemap: directive
# Sitemap itself is at /sitemap.xml
# -----------------------------------------------
